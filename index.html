<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hands Please - Supabase</title>
  <!-- Supabase JS client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
  <style>
    :root {
      --color-bg-primary: #fcfcf9;
      --color-bg-secondary: #fffffe;
      --color-text-primary: #13343b;
      --color-text-secondary: #626c7c;
      --color-accent: #21808d;
      --color-accent-hover: #1d7480;
      --color-border: rgba(94, 82, 64, 0.2);
      --color-card-bg: #ffffff;
      --color-danger: #b91c1c;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg-primary: #1f2121;
        --color-bg-secondary: #262828;
        --color-text-primary: #f5f5f5;
        --color-text-secondary: #a7a9a9;
        --color-accent: #32b8c6;
        --color-accent-hover: #2da6b2;
        --color-border: rgba(119, 124, 124, 0.3);
        --color-card-bg: #262828;
        --color-danger: #fecaca;
      }
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:var(--color-bg-primary);
      color:var(--color-text-primary);
      line-height:1.6;
    }
    .header {
      background:var(--color-accent);
      color:#fff;
      padding:1.5rem 1rem 2.25rem;
      text-align:center;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
      position:relative;
    }
    .header h1 { font-size:2rem; font-weight:600; margin-bottom:.25rem; }
    .header p { font-size:.95rem; opacity:.95; }
    .header .admin-login-btn{
      position:absolute; top:1rem; right:1rem;
      background:rgba(255,255,255,.2);
      color:#fff; border:1px solid rgba(255,255,255,.4);
      padding:.5rem 1rem; border-radius:6px;
      cursor:pointer; font-size:.85rem;
    }
    .header .admin-login-btn:hover{ background:rgba(255,255,255,.3); }
    .container{ max-width:1200px; margin:0 auto; padding:1rem 1rem 2.5rem; }
    .tabs{
      margin-top:-1.5rem; margin-bottom:1.5rem;
      display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap;
    }
    .tab-btn{
      padding:.5rem 1rem; border-radius:999px;
      border:1px solid rgba(255,255,255,.6);
      background:rgba(255,255,255,.15);
      color:#fff; font-size:.85rem;
      cursor:pointer; backdrop-filter:blur(8px);
    }
    .tab-btn.active{ background:#fff; color:var(--color-accent); }
    .search-bar{ margin-bottom:1rem; }
    .search-bar input{
      width:100%; padding:.75rem 1rem; font-size:1rem;
      border:1px solid var(--color-border); border-radius:8px;
      background:var(--color-card-bg); color:var(--color-text-primary);
    }
    .filters{
      display:flex; gap:.75rem; margin-bottom:1rem; flex-wrap:wrap;
    }
    .filter-btn{
      padding:.4rem .9rem; border:1px solid var(--color-border);
      background:var(--color-card-bg); color:var(--color-text-primary);
      border-radius:20px; cursor:pointer; font-size:.85rem;
      transition:all .2s;
    }
    .filter-btn.active{
      background:var(--color-accent); color:#fff; border-color:var(--color-accent);
    }
    .menu-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:1.25rem;
    }
    .card{
      background:var(--color-card-bg);
      border:1px solid var(--color-border);
      border-radius:12px; overflow:hidden;
      transition:transform .2s, box-shadow .2s;
      cursor:pointer; position:relative;
    }
    .card:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 16px rgba(0,0,0,.08);
    }
    .card-image{
      width:100%; height:180px; object-fit:cover;
      background:linear-gradient(135deg,#e2e8f0 0%,#cbd5e1 100%);
    }
    .card-content{ padding:1rem 1.1rem 1rem; }
    .card-title{ font-size:1.1rem; font-weight:600; margin-bottom:.35rem; }
    .card-preview{
      color:var(--color-text-secondary); font-size:.85rem;
      line-height:1.5; display:-webkit-box;
      -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .dietary-tags{ display:flex; flex-wrap:wrap; gap:.35rem; margin-bottom:.6rem; }
    .dietary-tag{
      padding:.2rem .6rem; border-radius:999px;
      font-size:.7rem; font-weight:500;
      background:rgba(33,128,141,.12); color:var(--color-accent);
    }
    .admin-chip{
      position:absolute; top:.6rem; left:.6rem;
      background:rgba(15,118,110,.9); color:#fff;
      padding:.1rem .5rem; font-size:.7rem; border-radius:999px;
      display:none;
    }
    .admin-mode .admin-chip{ display:inline-block; }
    .modal{
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,.7); z-index:1000;
      overflow-y:auto; padding:2rem 1rem;
    }
    .modal.active{ display:flex; justify-content:center; align-items:flex-start; }
    .modal-content{
      background:var(--color-card-bg); border-radius:12px;
      max-width:900px; width:100%; margin:auto;
      max-height:90vh; overflow-y:auto;
    }
    .modal-close{
      position:sticky; top:0; right:0; background:var(--color-accent);
      color:#fff; border:none; width:40px; height:40px;
      border-radius:50%; font-size:1.5rem; cursor:pointer;
      float:right; margin:1rem 1rem 0 0; z-index:10;
    }
    .modal-image{ width:100%; height:260px; object-fit:cover; }
    .modal-body{ padding:1.75rem 2rem 2rem; clear:both; }
    .modal-title{ font-size:1.8rem; font-weight:600; margin-bottom:.4rem; }
    .section{ margin-bottom:1.5rem; }
    .section-title{
      font-size:1.05rem; font-weight:600;
      color:var(--color-accent); margin-bottom:.5rem;
      padding-bottom:.4rem; border-bottom:2px solid var(--color-border);
    }
    .section-content{ color:var(--color-text-secondary); line-height:1.7; }
    .section-content ul{ list-style:none; padding-left:0; }
    .section-content li{
      padding:.35rem 0 .35rem 1.5rem; position:relative; font-size:.95rem;
    }
    .section-content li:before{
      content:"‚Ä¢"; position:absolute; left:0;
      color:var(--color-accent); font-weight:bold;
    }
    .modification-item{
      background:rgba(33,128,141,.08); padding:.6rem;
      border-radius:8px; margin-bottom:.45rem; font-size:.9rem;
    }
    .available{ color:#059669; font-weight:500; }
    .not-available{ color:#dc2626; font-weight:500; }
    .info-box{
      background:linear-gradient(135deg,rgba(33,128,141,.1) 0%,rgba(33,128,141,.05) 100%);
      padding:1rem; border-radius:8px;
      border-left:4px solid var(--color-accent); font-size:.95rem;
    }
    .admin-banner{
      display:none; margin-bottom:.75rem;
      padding:.7rem .9rem; border-radius:8px;
      background:#fef3c7; color:#92400e;
      border-left:4px solid #f59e0b; font-size:.85rem;
    }
    .admin-mode .admin-banner{ display:block; }
    .admin-floating{
      position:fixed; bottom:1rem; right:1rem;
      display:none; flex-direction:column; gap:.5rem; z-index:1100;
    }
    .admin-mode .admin-floating{ display:flex; }
    .admin-btn{
      border:none; padding:.55rem .85rem;
      border-radius:999px; cursor:pointer; font-size:.85rem;
      box-shadow:0 4px 10px rgba(0,0,0,.15);
      display:flex; align-items:center; gap:.35rem;
    }
    .admin-btn-primary{ background:var(--color-accent); color:#fff; }
    .admin-btn-secondary{ background:#fff; color:var(--color-text-primary); }
    .admin-btn-danger{ background:#b91c1c; color:#fff; }
    .editor-modal{
      display:none; position:fixed; inset:0;
      background:rgba(15,23,42,.7); z-index:1200;
      overflow-y:auto; padding:1.5rem .75rem;
    }
    .editor-modal.active{
      display:flex; justify-content:center; align-items:flex-start;
    }
    .editor-content{
      background:var(--color-card-bg);
      border-radius:12px; max-width:900px;
      width:100%; margin:auto; padding:1.4rem 1.4rem 1.6rem;
    }
    .editor-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:.75rem;
    }
    .editor-title{ font-size:1.1rem; font-weight:600; }
    .editor-close-btn{
      border:none; background:transparent;
      font-size:1.4rem; cursor:pointer;
      color:var(--color-text-secondary);
    }
    .editor-grid{
      display:grid;
      grid-template-columns:minmax(0,1.05fr) minmax(0,.95fr);
      gap:1rem; margin-top:.5rem;
    }
    .form-group{ margin-bottom:.6rem; }
    .form-group label{
      display:block; font-size:.8rem; font-weight:600;
      margin-bottom:.25rem; color:var(--color-text-secondary);
    }
    .form-group input[type="text"],
    .form-group textarea{
      width:100%; padding:.5rem .55rem; font-size:.85rem;
      border-radius:6px; border:1px solid var(--color-border);
      background:var(--color-bg-secondary); color:var(--color-text-primary);
    }
    .form-group textarea{ min-height:80px; resize:vertical; }
    .checkbox-row{
      display:flex; flex-wrap:wrap; gap:.4rem .9rem;
    }
    .checkbox-row label{
      font-weight:400; font-size:.8rem;
      display:flex; align-items:center; gap:.25rem;
    }
    .list-editor{
      border-radius:8px; border:1px solid var(--color-border);
      padding:.5rem; max-height:210px; overflow-y:auto;
      background:var(--color-bg-secondary);
    }
    .list-row{
      display:flex; gap:.35rem; margin-bottom:.35rem;
    }
    .list-row input{
      flex:1; padding:.4rem .5rem; border-radius:5px;
      border:1px solid var(--color-border); font-size:.8rem;
    }
    .list-row button{
      border:none; background:#fee2e2; color:#b91c1c;
      border-radius:5px; padding:.25rem .4rem; font-size:.75rem; cursor:pointer;
    }
    .list-add-btn{
      margin-top:.35rem; border:none; background:#ecfdf3;
      color:#047857; border-radius:999px;
      padding:.25rem .6rem; font-size:.8rem; cursor:pointer;
    }
    .mod-row{
      display:grid;
      grid-template-columns:.7fr .45fr 1.3fr auto;
      gap:.35rem; margin-bottom:.35rem;
    }
    .mod-row input,.mod-row select{
      padding:.35rem .4rem; border-radius:5px;
      border:1px solid var(--color-border); font-size:.78rem;
    }
    .editor-actions{
      margin-top:.75rem; display:flex;
      justify-content:space-between; gap:.5rem; flex-wrap:wrap;
    }
    .btn{
      border-radius:999px; border:none;
      padding:.45rem .9rem; font-size:.85rem; cursor:pointer;
    }
    .btn-primary{ background:var(--color-accent); color:#fff; }
    .btn-secondary{ background:#e5e7eb; color:#111827; }
    .btn-danger{ background:#b91c1c; color:#fff; }
    .small-hint{ font-size:.72rem; color:var(--color-text-secondary); }
    @media (max-width:900px){
      .editor-grid{ grid-template-columns:minmax(0,1fr); }
    }
    @media (max-width:768px){
      .menu-grid{ grid-template-columns:1fr; }
      .modal-content{ margin:1rem; }
      .header h1{ font-size:1.5rem; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="admin-login-btn" onclick="handleAdminButtonClick()">üîí Admin</button>
    <a class="admin-login-btn" href="./quiz.html">üéÆ Menu Quiz</a>
    <h1>üñêÔ∏è Hands Please</h1>
    <p>Food syllabus</p>
    <p style="font-size:0.8rem; opacity:0.85; margin-top:0.4rem;">&copy; 2026 K Iyer. Internal training tool only.</p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="food" onclick="switchTab('food')">Food</button>
  </div>

  <div class="container">
    <div id="adminBanner" class="admin-banner">
      <strong>ADMIN MODE:</strong> Uses Supabase (cloud) instead of local JSON. Tap any card to edit, changes sync across devices.
    </div>

    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="üîç Search by name, ingredient, etc.">
    </div>

    <div id="foodFilters" class="filters">
      <button class="filter-btn active" data-filter="all" onclick="setFoodFilter('all')">All Dishes</button>
      <button class="filter-btn" data-filter="vegan" onclick="setFoodFilter('vegan')">Vegan</button>
      <button class="filter-btn" data-filter="vegetarian" onclick="setFoodFilter('vegetarian')">Vegetarian</button>
      <button class="filter-btn" data-filter="gluten-free" onclick="setFoodFilter('gluten-free')">Gluten Free</button>
      <button class="filter-btn" data-filter="dairy-free" onclick="setFoodFilter('dairy-free')">Dairy Free</button>
      <button class="filter-btn" data-filter="shellfish" onclick="setFoodFilter('shellfish')">Shellfish</button>
      <button class="filter-btn" data-filter="fin-fish" onclick="setFoodFilter('fin-fish')">Fin Fish</button>
      <button class="filter-btn" data-filter="pork" onclick="setFoodFilter('pork')">Pork</button>
      <button class="filter-btn" data-filter="alcohol" onclick="setFoodFilter('alcohol')">Alcohol</button>
      <button class="filter-btn" data-filter="onion-garlic" onclick="setFoodFilter('onion-garlic')">Onion/Garlic</button>
    </div>

    <div id="contentGrid" class="menu-grid"></div>
  </div>

  <div class="modal" id="detailModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeDetailModal()">&times;</button>
      <div id="modalInner"></div>
    </div>
  </div>

  <div class="editor-modal" id="editorModal">
    <div class="editor-content">
      <div class="editor-header">
        <div>
          <div class="editor-title" id="editorTitle"></div>
          <div class="small-hint" id="editorHint"></div>
        </div>
        <button class="editor-close-btn" onclick="closeEditor()">√ó</button>
      </div>
      <div id="editorBody"></div>
    </div>
  </div>

  <div class="admin-floating" id="adminControls">
    <button class="admin-btn admin-btn-primary" onclick="openAddItem()">‚ûï Add dish</button>
    <button class="admin-btn admin-btn-danger" onclick="logoutAdmin()">üîì Exit admin</button>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = "https://beyeqxromrqoiruejddp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJleWVxeHJvbXJxb2lydWVqZGRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MjcwMDEsImV4cCI6MjA4NTUwMzAwMX0.LIt8CG0DYeQDXE1RhvGPNyjVdK8SarSGuXJJJd2Ku7o";

    const { createClient } = window.supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let foodItems = [];
    let currentTab = "food";
    let isAdmin = false;
    let foodFilter = "all";
    let searchTerm = "";
    let editorState = { index: null, id: null }; // for food_items

    async function loadFood() {
      const { data, error } = await supabaseClient
        .from("food_items")
        .select("*")
        .order("created_at", { ascending: true });

      if (error) {
        console.error("Error loading food_items", error);
        alert("Error loading dishes from Supabase.");
        return;
      }
      foodItems = (data || []).map(row => ({
        id: row.id,
        name: row.name || "",
        image: row.image_url || "",
        dietaries: row.dietaries ? row.dietaries.split(",").map(s => s.trim()).filter(Boolean) : [],
        ingredients: row.ingredients ? row.ingredients.split("\n") : [],
        miseEnPlace: row.mise_en_place ? row.mise_en_place.split("\n") : [],
        modifications: row.modifications ? safeParseJSON(row.modifications, []) : [],
        interestingInfo: row.interesting_info || ""
      }));
      renderGrid();
    }

    function safeParseJSON(str, fallback) {
      try {
        const v = JSON.parse(str);
        return Array.isArray(v) || typeof v === "object" ? v : fallback;
      } catch {
        return fallback;
      }
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
      });
      renderGrid();
    }

    function setFoodFilter(filter) {
      foodFilter = filter;
      document.querySelectorAll("#foodFilters .filter-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.filter === filter);
      });
      renderGrid();
    }

    document.getElementById("searchInput").addEventListener("input", e => {
      searchTerm = e.target.value.trim().toLowerCase();
      renderGrid();
    });

    function renderGrid() {
      const grid = document.getElementById("contentGrid");
      let items = [...foodItems];

      if (foodFilter !== "all") {
        items = items.filter(d => d.dietaries && d.dietaries.includes(foodFilter));
      }

      if (searchTerm) {
        items = items.filter(item => {
          const haystack = [];
          haystack.push(item.name || "");
          (item.ingredients || []).forEach(x => haystack.push(x));
          (item.miseEnPlace || []).forEach(x => haystack.push(x));
          haystack.push(item.interestingInfo || "");
          (item.dietaries || []).forEach(x => haystack.push(x));
          return haystack.join(" ").toLowerCase().includes(searchTerm);
        });
      }

      if (!items.length) {
        grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--color-text-secondary); padding:2rem 0;">No dishes yet. In admin mode, click ‚ÄúAdd dish‚Äù.</p>';
        document.body.classList.toggle("admin-mode", isAdmin);
        document.getElementById("adminBanner").style.display = isAdmin ? "block" : "none";
        return;
      }

      grid.innerHTML = items.map((item, idx) => `
        <div class="card" onclick="handleCardClick(${idx})">
          <div class="admin-chip">Edit</div>
          <img src="${item.image || ""}" alt="${item.name || ""}" class="card-image"
            onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22600%22%3E%3Crect fill=%22%23e2e8f0%22 width=%22800%22 height=%22600%22/%3E%3Ctext fill=%22%2394a3b8%22 font-family=%22Arial%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3E${encodeURIComponent(item.name || "")}%3C/text%3E%3C/svg%3E'">
          <div class="card-content">
            <h3 class="card-title">${item.name || ""}</h3>
            <div class="dietary-tags">
              ${(item.dietaries || []).map(d => `<span class="dietary-tag">${formatDietary(d)}</span>`).join("")}
            </div>
            <p class="card-preview">${item.interestingInfo || ""}</p>
          </div>
        </div>
      `).join("");

      document.body.classList.toggle("admin-mode", isAdmin);
      document.getElementById("adminBanner").style.display = isAdmin ? "block" : "none";
    }

    function formatDietary(d) {
      if (!d) return "";
      return d.split("-").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
    }

    function handleCardClick(index) {
      if (isAdmin) {
        openEditor(index);
      } else {
        openDetailModal(index);
      }
    }

    function openDetailModal(index) {
      const item = foodItems[index];
      if (!item) return;
      const modal = document.getElementById("detailModal");
      const inner = document.getElementById("modalInner");

      inner.innerHTML = `
        <img src="${item.image || ""}" alt="${item.name || ""}" class="modal-image" onerror="this.style.display='none'">
        <div class="modal-body">
          <h2 class="modal-title">${item.name || ""}</h2>
          <div class="dietary-tags" style="margin-bottom:1rem;">
            ${(item.dietaries || []).map(d => `<span class="dietary-tag">${formatDietary(d)}</span>`).join("")}
          </div>

          <div class="section">
            <h3 class="section-title">üìã Mise en Place for Service</h3>
            <div class="section-content">
              <ul>${(item.miseEnPlace || []).map(x => `<li>${x}</li>`).join("")}</ul>
            </div>
          </div>

          <div class="section">
            <h3 class="section-title">ü•ò Ingredients</h3>
            <div class="section-content">
              <ul>${(item.ingredients || []).map(x => `<li>${x}</li>`).join("")}</ul>
            </div>
          </div>

          <div class="section">
            <h3 class="section-title">üîÑ Dietary Modifications</h3>
            <div class="section-content">
              ${(item.modifications || []).map(mod => `
                <div class="modification-item">
                  <strong>${mod.dietary || ""}:</strong>
                  <span class="${mod.available ? "available" : "not-available"}">
                    ${mod.available ? "‚úì Available" : "‚úó Not Available"}
                  </span><br>
                  <small>${mod.note || ""}</small>
                </div>
              `).join("")}
            </div>
          </div>

          <div class="section">
            <h3 class="section-title">üí° Interesting Information</h3>
            <div class="info-box">${item.interestingInfo || ""}</div>
          </div>
        </div>
      `;
      modal.classList.add("active");
      document.body.style.overflow = "hidden";
    }

    function closeDetailModal() {
      document.getElementById("detailModal").classList.remove("active");
      document.body.style.overflow = "auto";
    }

    document.getElementById("detailModal").addEventListener("click", e => {
      if (e.target.id === "detailModal") closeDetailModal();
    });

    function handleAdminButtonClick() {
      if (isAdmin) {
        logoutAdmin();
      } else {
        const pwd = prompt("Enter admin password:");
        if (pwd === "Iworkfortips") {
          isAdmin = true;
          document.body.classList.add("admin-mode");
          renderGrid();
        } else if (pwd !== null) {
          alert("Incorrect password");
        }
      }
    }

    function logoutAdmin() {
      isAdmin = false;
      document.body.classList.remove("admin-mode");
    }

    function openAddItem() {
      editorState = { index: null, id: null };
      openEditor(null);
    }

    function openEditor(index) {
      const isNew = index === null || index === undefined;
      const modal = document.getElementById("editorModal");
      const titleEl = document.getElementById("editorTitle");
      const hintEl = document.getElementById("editorHint");
      const bodyEl = document.getElementById("editorBody");

      titleEl.textContent = isNew ? "Add Dish" : "Edit Dish";
      hintEl.textContent = "Saved to Supabase (cloud) so all devices see the same data.";

      const item = isNew ? createEmptyItem() : structuredClone(foodItems[index]);
      editorState.index = index;
      editorState.id = isNew ? null : item.id;

      bodyEl.innerHTML = renderFoodEditor(item);
      initFoodEditor(item);

      modal.classList.add("active");
      document.body.style.overflow = "hidden";
    }

    function closeEditor() {
      document.getElementById("editorModal").classList.remove("active");
      document.body.style.overflow = "auto";
    }

   function createEmptyItem() {
  return {
    id: null,
    name: "",
    image: "",
    dietaries: [],
    ingredients: [""],
    miseEnPlace: [""],
    modifications: [
      { dietary: "Vegan",         available: false, note: "" },
      { dietary: "Vegetarian",    available: false, note: "" },
      { dietary: "Gluten-Free",   available: false, note: "" },
      { dietary: "Dairy-Free",    available: false, note: "" },
      { dietary: "Nut Allergies", available: true,  note: "No nuts in dish" },
      { dietary: "Shellfish",     available: false, note: "" },
      { dietary: "Fin Fish",      available: false, note: "" },
      { dietary: "Pork",          available: false, note: "" },
      { dietary: "Alcohol",       available: false, note: "" },
      { dietary: "Onion/Garlic",  available: false, note: "" }
    ],
    interestingInfo: ""
  };
}
    function renderFoodEditor(item) {
      return `
      <div class="editor-grid">
        <div>
          <div class="form-group">
            <label>Dish name</label>
            <input type="text" id="foodName" value="${escapeHtml(item.name || "")}">
          </div>
          <div class="form-group">
            <label>Image</label>
            <input type="text" id="foodImage" value="${escapeHtml(item.image || "")}" placeholder="Existing image URL (will be replaced if you upload)">
            <input type="file" id="foodImageFile" accept="image/*" style="margin-top:0.35rem;">
            <div class="small-hint">If you choose a file, it will upload to Supabase Storage and update the image URL automatically.</div>
          </div>
          <div class="form-group">
            <label>Dietaries / allergens (tags shown on cards & filters)</label>
            <div class="checkbox-row">
              ${["vegan","vegetarian","gluten-free","dairy-free","nut-free","shellfish","fin-fish","pork","alcohol","onion-garlic"].map(d => `
                <label>
                  <input type="checkbox" class="foodDietary" value="${d}" ${item.dietaries && item.dietaries.includes(d) ? "checked" : ""}>
                  ${formatDietary(d)}
                </label>
              `).join("")}
            </div>
          </div>
          <div class="form-group">
            <label>Interesting information / talking points</label>
            <textarea id="foodInfo">${escapeHtml(item.interestingInfo || "")}</textarea>
          </div>
        </div>
        <div>
          <div class="form-group">
            <label>Mise en place (one line per bullet)</label>
            <div class="list-editor" id="foodMepList"></div>
            <button type="button" class="list-add-btn" onclick="addListRow('foodMepList')">+ Add line</button>
          </div>
          <div class="form-group">
            <label>Ingredients (one line per bullet)</label>
            <div class="list-editor" id="foodIngList"></div>
            <button type="button" class="list-add-btn" onclick="addListRow('foodIngList')">+ Add ingredient</button>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Dietary modifications</label>
        <div class="list-editor" id="foodModList"></div>
        <button type="button" class="list-add-btn" onclick="addModRow()">+ Add modification</button>
      </div>
      <div class="editor-actions">
        <div>
          <button class="btn btn-primary" onclick="saveFoodItem()">Save</button>
          <button class="btn btn-secondary" onclick="closeEditor()">Cancel</button>
        </div>
        <div>
          ${editorState.id ? '<button class="btn btn-danger" onclick="deleteCurrentItem()">Delete dish</button>' : ""}
        </div>
      </div>`;
    }

    function initFoodEditor(item) {
      renderListEditor(document.getElementById("foodMepList"), item.miseEnPlace || [""]);
      renderListEditor(document.getElementById("foodIngList"), item.ingredients || [""]);
      renderModEditor(document.getElementById("foodModList"), item.modifications || []);
    }

    function renderListEditor(container, items) {
      if (!items || !items.length) items = [""];
      container.innerHTML = items.map((val, idx) => `
        <div class="list-row">
          <input type="text" value="${escapeHtml(val)}" data-index="${idx}">
          <button type="button" onclick="removeListRow('${container.id}', ${idx})">‚úï</button>
        </div>
      `).join("");
    }

    function addListRow(containerId) {
      const container = document.getElementById(containerId);
      const rowCount = container.querySelectorAll(".list-row").length;
      const div = document.createElement("div");
      div.className = "list-row";
      div.innerHTML = `
        <input type="text" value="" data-index="${rowCount}">
        <button type="button" onclick="removeListRow('${containerId}', ${rowCount})">‚úï</button>
      `;
      container.appendChild(div);
    }

    function removeListRow(containerId, index) {
      const container = document.getElementById(containerId);
      const rows = Array.from(container.querySelectorAll(".list-row"));
      if (rows[index]) rows[index].remove();
    }

    function collectListValues(containerId) {
      const container = document.getElementById(containerId);
      const inputs = Array.from(container.querySelectorAll("input"));
      const values = inputs.map(i => i.value.trim()).filter(v => v);
      return values.length ? values : [];
    }

    function renderModEditor(container, mods) {
      if (!mods || !mods.length) {
        mods = [
          { dietary: "Vegan", available: false, note: "" },
          { dietary: "Vegetarian", available: false, note: "" },
          { dietary: "Gluten-Free", available: false, note: "" },
          { dietary: "Dairy-Free", available: false, note: "" },
          { dietary: "Nut Allergies", available: true, note: "" }
        ];
      }
      container.innerHTML = mods.map((mod, idx) => `
        <div class="mod-row">
          <input type="text" value="${escapeHtml(mod.dietary || "")}" placeholder="Dietary" data-mod-field="dietary" data-index="${idx}">
          <select data-mod-field="available" data-index="${idx}">
            <option value="true" ${mod.available ? "selected" : ""}>Available</option>
            <option value="false" ${!mod.available ? "selected" : ""}>Not available</option>
          </select>
          <input type="text" value="${escapeHtml(mod.note || "")}" placeholder="Note" data-mod-field="note" data-index="${idx}">
          <button type="button" onclick="removeModRow(${idx})">‚úï</button>
        </div>
      `).join("");
    }

    function addModRow() {
      const container = document.getElementById("foodModList");
      const idx = container.querySelectorAll(".mod-row").length;
      const div = document.createElement("div");
      div.className = "mod-row";
      div.innerHTML = `
        <input type="text" placeholder="Dietary" data-mod-field="dietary" data-index="${idx}">
        <select data-mod-field="available" data-index="${idx}">
          <option value="true" selected>Available</option>
          <option value="false">Not available</option>
        </select>
        <input type="text" placeholder="Note" data-mod-field="note" data-index="${idx}">
        <button type="button" onclick="removeModRow(${idx})">‚úï</button>
      `;
      container.appendChild(div);
    }

    function removeModRow(index) {
      const container = document.getElementById("foodModList");
      const rows = Array.from(container.querySelectorAll(".mod-row"));
      if (rows[index]) rows[index].remove();
    }

    function collectModValues() {
      const container = document.getElementById("foodModList");
      const rows = Array.from(container.querySelectorAll(".mod-row"));
      const mods = [];
      rows.forEach(row => {
        const inputs = row.querySelectorAll("[data-mod-field]");
        const mod = {};
        inputs.forEach(el => {
          const field = el.dataset.modField;
          if (field === "available") {
            mod[field] = el.value === "true";
          } else {
            mod[field] = el.value.trim();
          }
        });
        if (mod.dietary) mods.push(mod);
      });
      return mods;
    }

    async function saveFoodItem() {
      const name = document.getElementById("foodName").value.trim();
      if (!name) {
        alert("Dish name is required");
        return;
      }
      const imageField = document.getElementById("foodImage");
      const fileInput = document.getElementById("foodImageFile");
      const info = document.getElementById("foodInfo").value.trim();

      const dietaries = Array.from(document.querySelectorAll(".foodDietary:checked")).map(cb => cb.value);
      const miseEnPlace = collectListValues("foodMepList");
      const ingredients = collectListValues("foodIngList");
      const modifications = collectModValues();

      let imageUrl = imageField.value.trim();

      const file = fileInput.files && fileInput.files[0];
      if (file) {
        const fileExt = file.name.split(".").pop();
        const uniqueName = `${crypto.randomUUID()}.${fileExt}`;
        const { data: uploadData, error: uploadError } = await supabaseClient.storage
          .from("menu-images")
          .upload(uniqueName, file, { cacheControl: "3600", upsert: false });

        if (uploadError) {
          console.error(uploadError);
          alert("Image upload failed.");
          return;
        }

        const { data: publicData } = supabaseClient.storage.from("menu-images").getPublicUrl(uploadData.path);
        imageUrl = publicData.publicUrl;
      }

      const row = {
        name,
        image_url: imageUrl || null,
        dietaries: dietaries.join(","),
        ingredients: ingredients.join("\n"),
        mise_en_place: miseEnPlace.join("\n"),
        modifications: JSON.stringify(modifications),
        interesting_info: info
      };

      let error;
      if (editorState.id) {
        const { error: upError } = await supabaseClient
          .from("food_items")
          .update(row)
          .eq("id", editorState.id);
        error = upError;
      } else {
        const { data: insertData, error: inError } = await supabaseClient
          .from("food_items")
          .insert(row)
          .select("id")
          .single();
        error = inError;
        if (!error && insertData) editorState.id = insertData.id;
      }

      if (error) {
        console.error(error);
        alert("Error saving dish.");
        return;
      }

      closeEditor();
      await loadFood();
    }

    async function deleteCurrentItem() {
      if (!editorState.id) return;
      if (!confirm("Delete this dish?")) return;

      const { error } = await supabaseClient
        .from("food_items")
        .delete()
        .eq("id", editorState.id);

      if (error) {
        console.error(error);
        alert("Error deleting dish.");
        return;
      }
      closeEditor();
      await loadFood();
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }

    (async function init() {
      await loadFood();
    })();
  </script>
</body>
</html>
