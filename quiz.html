<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breakfast Quiz</title>
  <style>
    :root{
      --eggshell: #f3efe6;
      --ink: #1f2328;
      --muted: #5d6671;
      --card: rgba(255,255,255,.72);
      --cardBorder: rgba(25, 25, 25, .10);
      --accent: #c07a2a;
      --danger: #b2342a;
      --ok: #2f7a45;

      --speckle1: rgba(55, 55, 55, .20);
      --speckle2: rgba(55, 55, 55, .12);
      --speckle3: rgba(55, 55, 55, .09);
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      background-color: var(--eggshell);
      background-image:
        radial-gradient(circle at 20% 30%, var(--speckle1) 0 1.1px, transparent 1.2px),
        radial-gradient(circle at 70% 60%, var(--speckle2) 0 0.9px, transparent 1.0px),
        radial-gradient(circle at 40% 80%, var(--speckle3) 0 1.4px, transparent 1.5px),
        linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,0));
      background-size: 90px 90px, 120px 120px, 160px 160px, 100% 100%;
      background-position: 0 0, 30px 15px, 10px 40px, 0 0;
      background-attachment: fixed;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 70px;
    }

    header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin: 6px 0 16px;
    }

    .titleBlock h1{
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: .2px;
    }
    .titleBlock .sub{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .hud{
      display: flex;
      align-items: center;
      gap: 14px;
    }

    /* Eggs: 3 lives */
    .eggs{
      display: inline-flex;
      gap: 10px;
      align-items: center;
      padding: 8px 10px;
      border: 1px solid var(--cardBorder);
      border-radius: 14px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(6px);
    }
    .egg{
      width: 26px;
      height: 34px;
      border-radius: 50% 50% 46% 46%;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.55));
      border: 1px solid rgba(20,20,20,.15);
      position: relative;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      transform-origin: 50% 70%;
    }
    .egg::after{
      content:"";
      position:absolute;
      inset: 8px 7px auto auto;
      width: 7px; height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,.55);
      transform: rotate(18deg);
    }
    .egg.cracked{
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.35));
    }
    .egg.cracked::before{
      content:"";
      position:absolute;
      inset: 0;
      background:
        linear-gradient(30deg, transparent 44%, rgba(40,40,40,.28) 45% 47%, transparent 48%),
        linear-gradient(-20deg, transparent 54%, rgba(40,40,40,.24) 55% 57%, transparent 58%),
        linear-gradient(70deg, transparent 62%, rgba(40,40,40,.22) 63% 65%, transparent 66%);
      opacity: .9;
      border-radius: inherit;
      pointer-events: none;
    }
    .egg.pop{
      animation: eggPop .38s ease-out;
    }
    @keyframes eggPop{
      0%{ transform: scale(1) rotate(0deg); }
      30%{ transform: scale(1.12) rotate(-7deg); }
      60%{ transform: scale(1.03) rotate(7deg); }
      100%{ transform: scale(1) rotate(0deg); }
    }

    /* Chicken mascot */
    .chicken{
      width: 88px;
      height: 64px;
      display: grid;
      place-items: center;
      border: 1px solid var(--cardBorder);
      border-radius: 14px;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(6px);
      overflow: hidden;
      position: relative;
    }
    .chicken svg{ width: 78px; height: 56px; }
    .chicken--happy svg{ animation: chickenHappy .55s ease-in-out; }
    .chicken--sad svg{ animation: chickenSad .55s ease-in-out; }
    .chicken--peck svg{ animation: chickenPeck .18s ease-in-out infinite; transform-origin: 55% 60%; }

    @keyframes chickenHappy{
      0%{ transform: translateY(0) rotate(0deg); }
      35%{ transform: translateY(-3px) rotate(-3deg); }
      70%{ transform: translateY(0) rotate(3deg); }
      100%{ transform: translateY(0) rotate(0deg); }
    }
    @keyframes chickenSad{
      0%{ transform: translateY(0) rotate(0deg); opacity: 1; }
      40%{ transform: translateY(2px) rotate(-6deg); opacity: .92; }
      100%{ transform: translateY(0) rotate(0deg); opacity: 1; }
    }
    @keyframes chickenPeck{
      0%{ transform: translateY(0) rotate(0deg); }
      50%{ transform: translateY(7px) rotate(10deg); }
      100%{ transform: translateY(0) rotate(0deg); }
    }

    .screenShake{
      animation: screenShake .18s linear infinite;
    }
    @keyframes screenShake{
      0%{ transform: translate(0,0); }
      25%{ transform: translate(1px, -1px); }
      50%{ transform: translate(-1px, 1px); }
      75%{ transform: translate(1px, 1px); }
      100%{ transform: translate(0,0); }
    }

    main{
      display: grid;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      padding: 14px;
      backdrop-filter: blur(8px);
      box-shadow: 0 18px 40px rgba(0,0,0,.06);
    }

    .qTop{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 8px;
    }
    .qNum{
      font-weight: 650;
      letter-spacing: .2px;
    }
    .score{
      color: var(--muted);
      font-size: 13px;
    }
    .question{
      font-size: 16px;
      line-height: 1.35;
      margin: 0 0 10px;
    }

    .answerArea{
      display: grid;
      gap: 10px;
    }

    textarea{
      width: 100%;
      min-height: 96px;
      resize: vertical;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.75);
      font-size: 14px;
      line-height: 1.35;
      outline: none;
    }
    textarea:focus{
      border-color: rgba(192,122,42,.55);
      box-shadow: 0 0 0 4px rgba(192,122,42,.16);
    }

    .choices{
      display: grid;
      gap: 8px;
    }
    .choice{
      display:flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.70);
      cursor: pointer;
      user-select: none;
    }
    .choice input{ margin-top: 2px; }
    .choice:hover{
      border-color: rgba(192,122,42,.45);
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    button{
      border: 0;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 650;
      cursor: pointer;
    }
    .btnPrimary{ background: var(--accent); color: #fff; }
    .btnPrimary:disabled{ opacity: .55; cursor: not-allowed; }
    .btnGhost{ background: rgba(0,0,0,.06); color: var(--ink); }
    .btnDanger{ background: var(--danger); color: #fff; }

    .feedback{
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
      min-height: 18px;
    }
    .feedback.good{ color: var(--ok); }
    .feedback.bad{ color: var(--danger); }

    footer{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px;
      background: rgba(243,239,230,.92);
      border-top: 1px solid rgba(0,0,0,.10);
      backdrop-filter: blur(8px);
    }
    .footInner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      font-size: 12.5px;
      color: var(--muted);
    }
    .footInner a{
      color: var(--ink);
      text-decoration: none;
      font-weight: 650;
    }
    .footInner a:hover{ text-decoration: underline; }

    /* Overlay (fail + admin) */
    .overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(15, 15, 18, .46);
      backdrop-filter: blur(6px);
      z-index: 50;
    }
    .overlay.show{ display: flex; }
    .modal{
      width: min(760px, 100%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.15);
      border-radius: 18px;
      box-shadow: 0 30px 80px rgba(0,0,0,.22);
      overflow: hidden;
    }
    .modalHead{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
    }
    .modalHead h2{
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .modalBody{
      padding: 14px;
      max-height: min(70vh, 640px);
      overflow: auto;
    }

    .bigFail{
      text-align: center;
      padding: 18px 14px;
    }
    .bigFail h3{
      margin: 0 0 8px;
      font-size: 26px;
      letter-spacing: .2px;
    }
    .bigFail p{
      margin: 0 0 14px;
      color: var(--muted);
    }

    /* Admin UI */
    .adminRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .adminRow button{ padding: 9px 10px; border-radius: 12px; }
    .adminList{
      display: grid;
      gap: 10px;
    }
    .adminItem{
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,.88);
    }
    .adminItemTop{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .adminItemTop .meta{
      font-size: 12px;
      color: var(--muted);
    }
    .adminItemTop .qtxt{
      font-weight: 650;
      margin: 0 0 2px;
    }
    .adminBtns{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .formGrid{
      display: grid;
      gap: 10px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 4px;
    }
    .field input[type="text"], .field input[type="number"], .field select, .field textarea{
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.18);
      padding: 9px 9px;
      background: rgba(255,255,255,.9);
      font-size: 13.5px;
      outline: none;
    }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(192,122,42,.55);
      box-shadow: 0 0 0 4px rgba(192,122,42,.14);
    }
    .miniHelp{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .pillRow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill{
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
    }

    @media (max-width: 640px){
      header{ align-items: flex-start; flex-direction: column; }
      .hud{ width: 100%; justify-content: space-between; }
      .chicken{ width: 100%; height: 68px; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="appWrap">
    <header>
      <div class="titleBlock">
        <h1>Breakfast Training Quiz</h1>
        <p class="sub">3 strikes and the chicken gets upset—answer carefully.</p>
      </div>

      <div class="hud">
        <div class="eggs" aria-label="Strikes">
          <div class="egg" id="egg1" aria-label="Egg 1"></div>
          <div class="egg" id="egg2" aria-label="Egg 2"></div>
          <div class="egg" id="egg3" aria-label="Egg 3"></div>
        </div>

        <div class="chicken" id="chickenBox" aria-label="Mama chicken mood">
          <!-- Simple inline SVG chicken -->
          <svg viewBox="0 0 120 90" role="img" aria-label="Chicken">
            <!-- body -->
            <ellipse cx="58" cy="52" rx="34" ry="24" fill="#fff7ea" stroke="rgba(0,0,0,.15)" stroke-width="2"/>
            <!-- wing -->
            <ellipse cx="52" cy="56" rx="16" ry="12" fill="#ffffff" stroke="rgba(0,0,0,.12)" stroke-width="2"/>
            <!-- head -->
            <circle cx="84" cy="40" r="16" fill="#fff7ea" stroke="rgba(0,0,0,.15)" stroke-width="2"/>
            <!-- comb -->
            <path d="M78 24 C82 18, 88 18, 90 26 C95 20, 103 23, 100 32 C94 30, 84 30, 78 24Z" fill="#d9433a"/>
            <!-- beak -->
            <path d="M99 42 L112 48 L99 54 Z" fill="#f0b24a" stroke="rgba(0,0,0,.12)" stroke-width="2" />
            <!-- eye -->
            <circle cx="88" cy="40" r="3.6" fill="#1f2328"/>
            <circle cx="89.5" cy="38.6" r="1.2" fill="#fff"/>
            <!-- legs -->
            <path d="M48 74 L44 86 M48 74 L52 86" stroke="#d59a3a" stroke-width="4" stroke-linecap="round"/>
            <path d="M66 74 L62 86 M66 74 L70 86" stroke="#d59a3a" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>
      </div>
    </header>

    <main>
      <section class="card" id="quizCard">
        <div class="qTop">
          <div class="qNum" id="qNum">Question 1 of 1</div>
          <div class="score" id="scoreLine">Correct: 0 · Wrong: 0</div>
        </div>

        <p class="question" id="questionText">Loading…</p>

        <div class="answerArea" id="answerArea"></div>

        <div class="actions">
          <button class="btnPrimary" id="submitBtn">Submit</button>
          <button class="btnGhost" id="skipBtn" title="Optional: skip without penalty">Skip</button>
        </div>

        <div class="feedback" id="feedback" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <footer>
    <div class="footInner">
      <div>Tip: refresh the page anytime to restart.</div>
      <a href="#" id="adminLink">Admin</a>
    </div>
  </footer>

  <!-- FAIL OVERLAY -->
  <div class="overlay" id="failOverlay" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h2>Quiz ended</h2>
        <button class="btnGhost" id="closeFailBtn" title="Close">Close</button>
      </div>
      <div class="modalBody">
        <div class="bigFail">
          <h3>Oh Oh! Study hard and try again!</h3>
          <p>You reached 3 incorrect answers.</p>
          <button class="btnPrimary" id="restartBtn">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN OVERLAY -->
  <div class="overlay" id="adminOverlay" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h2>Admin</h2>
        <button class="btnGhost" id="closeAdminBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="adminRow">
          <button class="btnPrimary" id="addQuestionBtn">Add question</button>
          <button class="btnGhost" id="resetDefaultBtn" title="Clear admin edits and go back to default syllabus-based questions">Reset to defaults</button>
          <button class="btnGhost" id="exportBtn" title="Copy question bank JSON to clipboard">Export JSON</button>
          <button class="btnGhost" id="importBtn" title="Paste JSON to replace question bank">Import JSON</button>
        </div>

        <div class="pillRow" id="adminStats"></div>

        <div class="adminList" id="adminList"></div>

        <hr style="border:none;border-top:1px solid rgba(0,0,0,.10);margin:14px 0;">

        <div id="editor" style="display:none;">
          <h3 style="margin:0 0 10px;font-size:15px;">Question editor</h3>

          <div class="formGrid">
            <div class="field">
              <label>Question text</label>
              <textarea id="edText" rows="3"></textarea>
            </div>

            <div class="field">
              <label>Type</label>
              <select id="edType">
                <option value="keyword">Written (keyword-based)</option>
                <option value="mcq">Multiple choice</option>
              </select>
            </div>

            <div class="field" id="keywordFields">
              <label>Required keywords/phrases (comma-separated)</label>
              <input type="text" id="edRequired" placeholder="e.g., circular economy, imperfect, cold pressed" />
              <div class="miniHelp">Grading is case-insensitive; punctuation is ignored. Use phrases if needed (e.g., “gluten free toast”).</div>
            </div>

            <div class="field" id="thresholdFields">
              <label>Threshold (how many required terms must match)</label>
              <input type="number" id="edThreshold" min="1" step="1" value="2" />
            </div>

            <div class="field" id="optionalFields">
              <label>Optional keywords (comma-separated)</label>
              <input type="text" id="edOptional" placeholder="e.g., fruits, vegetables, juice" />
            </div>

            <div class="field" id="mcqFields" style="display:none;">
              <label>Choices (one per line)</label>
              <textarea id="edChoices" rows="5" placeholder="Choice A&#10;Choice B&#10;Choice C"></textarea>
              <div class="miniHelp">After saving, choose the correct answer index below.</div>
            </div>

            <div class="field" id="mcqCorrectFields" style="display:none;">
              <label>Correct choice number (1-based)</label>
              <input type="number" id="edCorrectIndex" min="1" step="1" value="1" />
            </div>

            <div class="adminRow" style="margin-top:4px;">
              <button class="btnPrimary" id="saveQuestionBtn">Save</button>
              <button class="btnGhost" id="cancelEditBtn">Cancel</button>
              <button class="btnDanger" id="deleteEditingBtn" style="display:none;">Delete</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // DEFAULT QUESTION BANK
    // (Derived from your syllabus content; buffet prices excluded per instruction.)
    // Keyword sets are editable in Admin after testing.
    // -----------------------------

    const DEFAULT_BANK = [
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "Describe what Loop juices are to a guest.",
        required: ["circular economy", "imperfect", "cold pressed"],
        optional: ["fruits", "vegetables", "juice"],
        threshold: 2
      },
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "Is the farmhouse breakfast gluten free? Please explain.",
        required: ["gluten free", "not suitable for celiac", "same fryer"],
        optional: ["offer fruit", "cross contamination", "sausage", "bacon"],
        threshold: 2
      },
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "What items can vegan guests have off our menu? (Syllabus items only.)",
        required: ["fruit plate", "vegan mexican scramble"],
        optional: ["corn tortilla", "tofu", "gluten free", "dairy none"],
        threshold: 1
      },
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "What are the components of our power bowl?",
        required: ["mixed berries", "greek yoghurt", "smoothie", "granola", "fresh cut fruits"],
        optional: ["terra breads", "almond milk", "honey"],
        threshold: 3
      },
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "List the components of the avocado toast.",
        required: ["sourdough", "smashed avocado", "poached eggs", "radish", "pickled onion", "feta"],
        optional: ["roquito", "clarified butter", "garlic herb potatoes", "vine ripened tomatoes"],
        threshold: 3
      },
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "Is the oatmeal gluten and dairy free? (Mods are ok.)",
        required: ["cooked in water", "not suitable for celiac", "without compote"],
        optional: ["butter", "plain oatmeal", "facility that handles gluten"],
        threshold: 2
      },
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "What items can a gluten free guest have from our menu? (Syllabus items only.)",
        required: ["gluten free toast", "substitute gluten free toast", "corn tortilla", "fruit plate"],
        optional: ["not suitable for celiac", "same fryer", "offer fruit instead"],
        threshold: 2
      },
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "What does the Belgian (Liège) waffle come with?",
        required: ["fresh berries", "maple whipped cream", "salted caramel", "icing sugar"],
        optional: ["dusting"],
        threshold: 2
      },
      {
        id: crypto.randomUUID(),
        type: "keyword",
        text: "What options can lactose intolerant guests have off our menu? (Dairy allergy)",
        required: ["fruit plate", "vegan mexican scramble", "oatmeal cooked in water"],
        optional: ["without compote", "no dairy"],
        threshold: 2
      }
    ];

    // -----------------------------
    // STORAGE
    // -----------------------------
    const STORAGE_KEY = "breakfastQuiz.bank.v1";
    function loadBank(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(DEFAULT_BANK);
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed) || parsed.length === 0) return structuredClone(DEFAULT_BANK);
        return parsed;
      }catch{
        return structuredClone(DEFAULT_BANK);
      }
    }
    function saveBank(bank){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(bank));
    }

    // -----------------------------
    // QUIZ STATE
    // -----------------------------
    let bank = loadBank();
    let order = [];
    let idx = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let gameOver = false;

    // -----------------------------
    // DOM
    // -----------------------------
    const appWrap = document.getElementById("appWrap");
    const qNumEl = document.getElementById("qNum");
    const scoreLineEl = document.getElementById("scoreLine");
    const questionTextEl = document.getElementById("questionText");
    const answerAreaEl = document.getElementById("answerArea");
    const submitBtn = document.getElementById("submitBtn");
    const skipBtn = document.getElementById("skipBtn");
    const feedbackEl = document.getElementById("feedback");

    const eggEls = [document.getElementById("egg1"), document.getElementById("egg2"), document.getElementById("egg3")];
    const chickenBox = document.getElementById("chickenBox");

    const failOverlay = document.getElementById("failOverlay");
    const restartBtn = document.getElementById("restartBtn");
    const closeFailBtn = document.getElementById("closeFailBtn");

    const adminLink = document.getElementById("adminLink");
    const adminOverlay = document.getElementById("adminOverlay");
    const closeAdminBtn = document.getElementById("closeAdminBtn");
    const addQuestionBtn = document.getElementById("addQuestionBtn");
    const resetDefaultBtn = document.getElementById("resetDefaultBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const adminList = document.getElementById("adminList");
    const adminStats = document.getElementById("adminStats");

    const editor = document.getElementById("editor");
    const edText = document.getElementById("edText");
    const edType = document.getElementById("edType");
    const edRequired = document.getElementById("edRequired");
    const edOptional = document.getElementById("edOptional");
    const edThreshold = document.getElementById("edThreshold");
    const edChoices = document.getElementById("edChoices");
    const edCorrectIndex = document.getElementById("edCorrectIndex");
    const saveQuestionBtn = document.getElementById("saveQuestionBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const deleteEditingBtn = document.getElementById("deleteEditingBtn");

    const keywordFields = document.getElementById("keywordFields");
    const thresholdFields = document.getElementById("thresholdFields");
    const optionalFields = document.getElementById("optionalFields");
    const mcqFields = document.getElementById("mcqFields");
    const mcqCorrectFields = document.getElementById("mcqCorrectFields");

    let editingId = null;

    // -----------------------------
    // HELPERS
    // -----------------------------
    function setChickenMood(mood){
      chickenBox.classList.remove("chicken--happy","chicken--sad","chicken--peck");
      if(mood === "happy") chickenBox.classList.add("chicken--happy");
      if(mood === "sad") chickenBox.classList.add("chicken--sad");
      if(mood === "peck") chickenBox.classList.add("chicken--peck");
    }

    function normalizeText(s){
      return String(s || "")
        .toLowerCase()
        .replace(/[’']/g, "'")
        .replace(/[^a-z0-9\s']/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function splitCsv(s){
      return String(s || "")
        .split(",")
        .map(x => x.trim())
        .filter(Boolean);
    }

    function updateHUD(){
      qNumEl.textContent = `Question ${Math.min(idx+1, order.length)} of ${order.length}`;
      scoreLineEl.textContent = `Correct: ${correctCount} · Wrong: ${wrongCount}`;
      eggEls.forEach((el, i) => {
        el.classList.toggle("cracked", i < wrongCount);
      });
    }

    function popEgg(n){
      const i = Math.max(0, Math.min(2, n-1));
      const el = eggEls[i];
      el.classList.remove("pop");
      void el.offsetWidth;
      el.classList.add("pop");
    }

    function setFeedback(text, kind){
      feedbackEl.textContent = text || "";
      feedbackEl.classList.remove("good","bad");
      if(kind === "good") feedbackEl.classList.add("good");
      if(kind === "bad") feedbackEl.classList.add("bad");
    }

    function showFail(){
      gameOver = true;
      submitBtn.disabled = true;
      skipBtn.disabled = true;

      setChickenMood("peck");
      appWrap.classList.add("screenShake");

      failOverlay.classList.add("show");
      failOverlay.setAttribute("aria-hidden","false");
    }

    function hideFail(){
      failOverlay.classList.remove("show");
      failOverlay.setAttribute("aria-hidden","true");
      appWrap.classList.remove("screenShake");
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // -----------------------------
    // RENDER QUESTION
    // -----------------------------
    function renderQuestion(){
      setFeedback("", null);
      answerAreaEl.innerHTML = "";

      if(order.length === 0){
        questionTextEl.textContent = "No questions yet. Add some in Admin.";
        submitBtn.disabled = true;
        skipBtn.disabled = true;
        return;
      }

      const q = order[idx];
      questionTextEl.textContent = q.text;

      if(q.type === "mcq"){
        const wrap = document.createElement("div");
        wrap.className = "choices";
        q.choices.forEach((c, i) => {
          const row = document.createElement("label");
          row.className = "choice";
          row.innerHTML = `
            <input type="radio" name="mcq" value="${i}" />
            <div>${escapeHtml(c)}</div>
          `;
          wrap.appendChild(row);
        });
        answerAreaEl.appendChild(wrap);
      }else{
        const ta = document.createElement("textarea");
        ta.id = "writtenAnswer";
        ta.placeholder = "Type your answer here… (keywords matter)";
        answerAreaEl.appendChild(ta);
      }

      submitBtn.disabled = false;
      skipBtn.disabled = false;
      updateHUD();
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }

    // -----------------------------
    // GRADING
    // -----------------------------
    function gradeCurrent(){
      const q = order[idx];
      if(q.type === "mcq"){
        const picked = document.querySelector('input[name="mcq"]:checked');
        if(!picked) return { ok: false, reason: "Pick an option first." };
        const choiceIndex = Number(picked.value);
        const ok = choiceIndex === Number(q.correctIndex ?? 0);
        return { ok, reason: ok ? "Correct." : "Incorrect." };
      }

      const ta = document.getElementById("writtenAnswer");
      const user = normalizeText(ta ? ta.value : "");
      if(!user) return { ok: false, reason: "Type an answer first." };

      const required = Array.isArray(q.required) ? q.required : [];
      const threshold = Math.max(1, Number(q.threshold || 1));
      let hits = 0;

      for(const term of required){
        const t = normalizeText(term);
        if(!t) continue;
        // simple contains match; phrases work
        if(user.includes(t)) hits++;
      }

      const ok = hits >= Math.min(threshold, required.length || threshold);
      return { ok, reason: ok ? "Correct." : `Missing key details (${hits}/${Math.min(threshold, required.length || threshold)} required hits).` };
    }

    function nextQuestion(){
      idx++;
      if(idx >= order.length){
        // loop back to start by default
        idx = 0;
      }
      renderQuestion();
    }

    // -----------------------------
    // STRIKES
    // -----------------------------
    function onWrong(){
      wrongCount++;
      setChickenMood("sad");
      popEgg(wrongCount);
      updateHUD();

      if(wrongCount >= 3){
        showFail();
        setFeedback("Incorrect. Strike 3.", "bad");
        return;
      }
      setFeedback("Incorrect.", "bad");
    }

    function onCorrect(){
      correctCount++;
      setChickenMood("happy");
      updateHUD();
      setFeedback("Correct.", "good");
    }

    // -----------------------------
    // EVENTS
    // -----------------------------
    submitBtn.addEventListener("click", () => {
      if(gameOver) return;
      const result = gradeCurrent();

      // If missing input (no selection / empty text), don't count as wrong
      if(result.reason === "Pick an option first." || result.reason === "Type an answer first."){
        setFeedback(result.reason, "bad");
        setChickenMood("sad");
        return;
      }

      if(result.ok){
        onCorrect();
        // small delay feels better with animation
        setTimeout(() => {
          if(!gameOver) nextQuestion();
        }, 450);
      }else{
        onWrong();
        // if not game over, keep them on the same question so they can try again
      }
    });

    skipBtn.addEventListener("click", () => {
      if(gameOver) return;
      setFeedback("Skipped (no penalty).", null);
      setChickenMood("sad");
      nextQuestion();
    });

    restartBtn.addEventListener("click", () => {
      resetQuizState();
      hideFail();
      renderQuestion();
    });

    closeFailBtn.addEventListener("click", () => {
      // still gameOver, so user must Restart or refresh
      hideFail();
    });

    // -----------------------------
    // RESET QUIZ (eggs/chicken/state)
    // -----------------------------
    function resetQuizState(){
      bank = loadBank();
      order = shuffle(bank);
      idx = 0;
      correctCount = 0;
      wrongCount = 0;
      gameOver = false;
      submitBtn.disabled = false;
      skipBtn.disabled = false;
      eggEls.forEach(el => el.classList.remove("cracked","pop"));
      setChickenMood(null);
      appWrap.classList.remove("screenShake");
      setFeedback("", null);
      updateHUD();
    }

    // -----------------------------
    // ADMIN
    // -----------------------------
    function showAdmin(){
      adminOverlay.classList.add("show");
      adminOverlay.setAttribute("aria-hidden","false");
      renderAdminList();
    }

    function hideAdmin(){
      adminOverlay.classList.remove("show");
      adminOverlay.setAttribute("aria-hidden","true");
      hideEditor();
    }

    function promptAdmin(){
      const pw = prompt("Admin password:");
      if(pw === null) return;
      if(pw !== "Iworkfortips"){
        alert("Incorrect password.");
        return;
      }
      showAdmin();
    }

    function renderAdminList(){
      bank = loadBank();

      adminStats.innerHTML = "";
      const pill1 = document.createElement("div");
      pill1.className = "pill";
      pill1.textContent = `Questions: ${bank.length}`;
      adminStats.appendChild(pill1);

      const pill2 = document.createElement("div");
      pill2.className = "pill";
      pill2.textContent = `Storage: ${localStorage.getItem(STORAGE_KEY) ? "Custom (edited)" : "Default"}`;
      adminStats.appendChild(pill2);

      adminList.innerHTML = "";
      bank.forEach((q, i) => {
        const item = document.createElement("div");
        item.className = "adminItem";
        item.innerHTML = `
          <div class="adminItemTop">
            <div>
              <div class="qtxt">${escapeHtml(q.text)}</div>
              <div class="meta">#${i+1} · ${q.type === "mcq" ? "Multiple choice" : "Keyword"} </div>
            </div>
            <div class="adminBtns">
              <button class="btnGhost" data-act="edit" data-id="${q.id}">Edit</button>
              <button class="btnDanger" data-act="del" data-id="${q.id}">Delete</button>
            </div>
          </div>
          <div class="meta">
            ${q.type === "mcq"
              ? `Choices: ${(q.choices||[]).length} · Correct: ${Number(q.correctIndex ?? 0)+1}`
              : `Required: ${(q.required||[]).length} · Threshold: ${q.threshold || 1}`
            }
          </div>
        `;
        adminList.appendChild(item);
      });

      adminList.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          const id = btn.getAttribute("data-id");
          if(act === "edit") startEdit(id);
          if(act === "del") deleteQuestion(id);
        });
      });
    }

    function showEditor(){
      editor.style.display = "block";
    }
    function hideEditor(){
      editingId = null;
      editor.style.display = "none";
      deleteEditingBtn.style.display = "none";
      edText.value = "";
      edType.value = "keyword";
      edRequired.value = "";
      edOptional.value = "";
      edThreshold.value = 2;
      edChoices.value = "";
      edCorrectIndex.value = 1;
      toggleEditorFields();
    }

    function toggleEditorFields(){
      const t = edType.value;
      const isMCQ = t === "mcq";
      keywordFields.style.display = isMCQ ? "none" : "block";
      thresholdFields.style.display = isMCQ ? "none" : "block";
      optionalFields.style.display = isMCQ ? "none" : "block";
      mcqFields.style.display = isMCQ ? "block" : "none";
      mcqCorrectFields.style.display = isMCQ ? "block" : "none";
    }

    function startAdd(){
      hideEditor();
      showEditor();
      editingId = null;
      deleteEditingBtn.style.display = "none";
      edText.focus();
    }

    function startEdit(id){
      const q = bank.find(x => x.id === id);
      if(!q) return;

      showEditor();
      editingId = id;
      deleteEditingBtn.style.display = "inline-block";

      edText.value = q.text || "";
      edType.value = q.type || "keyword";

      if(q.type === "mcq"){
        edChoices.value = (q.choices || []).join("\n");
        edCorrectIndex.value = Number(q.correctIndex ?? 0) + 1;
      }else{
        edRequired.value = (q.required || []).join(", ");
        edOptional.value = (q.optional || []).join(", ");
        edThreshold.value = Number(q.threshold || 1);
      }
      toggleEditorFields();
      edText.focus();
    }

    function deleteQuestion(id){
      if(!confirm("Delete this question?")) return;
      bank = bank.filter(q => q.id !== id);
      saveBank(bank);
      renderAdminList();
      // keep quiz using updated bank next restart/refresh
    }

    function saveQuestion(){
      const text = edText.value.trim();
      if(!text){
        alert("Question text is required.");
        return;
      }

      const type = edType.value;

      const base = { id: editingId || crypto.randomUUID(), type, text };

      let q = null;

      if(type === "mcq"){
        const choices = edChoices.value.split("\n").map(s => s.trim()).filter(Boolean);
        if(choices.length < 2){
          alert("Add at least 2 choices.");
          return;
        }
        const correct1 = Math.max(1, Number(edCorrectIndex.value || 1));
        const correctIndex = Math.min(choices.length, correct1) - 1;

        q = { ...base, choices, correctIndex };
      }else{
        const required = splitCsv(edRequired.value);
        if(required.length === 0){
          alert("Add at least 1 required keyword.");
          return;
        }
        const optional = splitCsv(edOptional.value);
        const threshold = Math.max(1, Math.min(required.length, Number(edThreshold.value || 1)));

        q = { ...base, required, optional, threshold };
      }

      const exists = bank.some(x => x.id === q.id);
      if(exists){
        bank = bank.map(x => x.id === q.id ? q : x);
      }else{
        bank = [...bank, q];
      }

      saveBank(bank);
      renderAdminList();
      hideEditor();
    }

    function resetToDefaults(){
      if(!confirm("Reset to default syllabus-based questions? This deletes your admin edits.")) return;
      localStorage.removeItem(STORAGE_KEY);
      bank = loadBank();
      renderAdminList();
    }

    function exportJson(){
      const json = JSON.stringify(loadBank(), null, 2);
      navigator.clipboard.writeText(json).then(
        () => alert("Copied question bank JSON to clipboard."),
        () => alert("Could not copy automatically. Your browser blocked clipboard access.")
      );
    }

    function importJson(){
      const raw = prompt("Paste question bank JSON here:");
      if(raw === null) return;
      try{
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) throw new Error("Not an array");
        // basic validation
        for(const q of parsed){
          if(!q.id) q.id = crypto.randomUUID();
          if(!q.text || !q.type) throw new Error("Missing fields");
          if(q.type === "mcq"){
            if(!Array.isArray(q.choices) || q.choices.length < 2) throw new Error("Bad MCQ");
            q.correctIndex = Number(q.correctIndex ?? 0);
          }else{
            if(!Array.isArray(q.required) || q.required.length < 1) throw new Error("Bad keyword question");
            q.threshold = Number(q.threshold ?? 1);
            q.optional = Array.isArray(q.optional) ? q.optional : [];
          }
        }
        saveBank(parsed);
        bank = loadBank();
        renderAdminList();
        alert("Imported.");
      }catch(e){
        alert("Import failed: " + (e.message || "Invalid JSON"));
      }
    }

    adminLink.addEventListener("click", (e) => {
      e.preventDefault();
      promptAdmin();
    });
    closeAdminBtn.addEventListener("click", hideAdmin);
    addQuestionBtn.addEventListener("click", startAdd);
    resetDefaultBtn.addEventListener("click", resetToDefaults);
    exportBtn.addEventListener("click", exportJson);
    importBtn.addEventListener("click", importJson);

    edType.addEventListener("change", toggleEditorFields);
    saveQuestionBtn.addEventListener("click", saveQuestion);
    cancelEditBtn.addEventListener("click", hideEditor);
    deleteEditingBtn.addEventListener("click", () => {
      if(!editingId) return;
      deleteQuestion
